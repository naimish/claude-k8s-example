name: CD - Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., main-abc123)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.platform.example.com
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Verify image exists
        run: |
          echo "Verifying image tag: ${{ inputs.image_tag }}"
          # Note: In production, add actual image verification logic here

      - name: Update Helm dependencies
        run: |
          helm dependency update helm/umbrella

      - name: Deploy to staging
        run: |
          helm upgrade --install microservices-platform helm/umbrella \
            --namespace staging \
            --create-namespace \
            --values helm/umbrella/values-staging.yaml \
            --set api-service.image.tag=${{ inputs.image_tag }} \
            --set worker-service.image.tag=${{ inputs.image_tag }} \
            --set web-frontend.image.tag=${{ inputs.image_tag }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          echo "Waiting for deployments to be ready..."
          kubectl rollout status deployment/microservices-platform-api-service -n staging --timeout=5m
          kubectl rollout status deployment/microservices-platform-worker-service -n staging --timeout=5m
          kubectl rollout status deployment/microservices-platform-web-frontend -n staging --timeout=5m

      - name: Run integration tests
        run: |
          echo "Running integration tests..."

          # Get service endpoints
          API_POD=$(kubectl get pod -n staging -l app.kubernetes.io/name=api-service -o jsonpath='{.items[0].metadata.name}')
          WORKER_POD=$(kubectl get pod -n staging -l app.kubernetes.io/name=worker-service -o jsonpath='{.items[0].metadata.name}')
          FRONTEND_POD=$(kubectl get pod -n staging -l app.kubernetes.io/name=web-frontend -o jsonpath='{.items[0].metadata.name}')

          # Test API service
          kubectl exec -n staging $API_POD -- curl -f http://localhost:8080/health || exit 1
          kubectl exec -n staging $API_POD -- curl -f http://localhost:8080/ready || exit 1
          kubectl exec -n staging $API_POD -- curl -f http://localhost:8080/api/info || exit 1
          echo "API service tests passed"

          # Test worker service
          kubectl exec -n staging $WORKER_POD -- curl -f http://localhost:8080/health || exit 1
          kubectl exec -n staging $WORKER_POD -- curl -f http://localhost:8080/metrics || exit 1
          echo "Worker service tests passed"

          # Test frontend
          kubectl exec -n staging $FRONTEND_POD -- curl -f http://localhost:8080/health || exit 1
          kubectl exec -n staging $FRONTEND_POD -- curl -f http://localhost:8080/api/status || exit 1
          echo "Frontend tests passed"

          echo "All integration tests passed!"

      - name: Check autoscaling configuration
        run: |
          echo "Verifying HPA configuration..."
          kubectl get hpa -n staging -l app.kubernetes.io/instance=microservices-platform

      - name: Get deployment info
        run: |
          echo "Deployment to staging successful!"
          echo "Image tag: ${{ inputs.image_tag }}"
          kubectl get pods -n staging -l app.kubernetes.io/instance=microservices-platform
          kubectl get svc -n staging -l app.kubernetes.io/instance=microservices-platform
          kubectl get hpa -n staging -l app.kubernetes.io/instance=microservices-platform

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deployment to staging failed!"
          kubectl get events -n staging --sort-by='.lastTimestamp' | tail -30

      - name: Post-deployment summary
        if: always()
        run: |
          echo "### Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
